<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Find The Misbehaving Nodes :: Apache Cassandra Documentation</title>
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Apache Cassandra Documentation&nbsp;&nbsp;&nbsp;<img src="../../../../_/img/cassandra_logo.png"></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Developer Mailing List</a>
            <a class="navbar-item" href="#">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ASCIIDOC_POC" data-version="4.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">ASCIIDOC_POC</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Cassandra Documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../new/index.html">What&#8217;s new</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../data_modeling/index.html">Data Modeling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/appendices.html">Appendices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/index.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operating/index.html">Operating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools/index.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/index.html">Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/index.html">Plug-ins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../faq/index.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ASCIIDOC_POC</span>
    <span class="version">4.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ASCIIDOC_POC</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">ASCIIDOC_POC</a></li>
    <li><a href="finding_nodes.html">Find The Misbehaving Nodes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/troubleshooting/finding_nodes.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Find The Misbehaving Nodes</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The first step to troubleshooting a Cassandra issue is to use error
messages, metrics and monitoring information to identify if the issue
lies with the clients or the server and if it does lie with the server
find the problematic nodes in the Cassandra cluster. The goal is to
determine if this is a systemic issue (e.g. a query pattern that affects
the entire cluster) or isolated to a subset of nodes (e.g. neighbors
holding a shared token range or even a single node with bad hardware).</p>
</div>
<div class="paragraph">
<p>There are many sources of information that help determine where the
problem lies. Some of the most common are mentioned below.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="client-logs-and-errors"><a class="anchor" href="#client-logs-and-errors"></a>Client Logs and Errors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Clients of the cluster often leave the best breadcrumbs to follow.
Perhaps client latencies or error rates have increased in a particular
datacenter (likely eliminating other datacenter&#8217;s nodes), or clients are
receiving a particular kind of error code indicating a particular kind
of problem. Troubleshooters can often rule out many failure modes just
by reading the error messages. In fact, many Cassandra error messages
include the last coordinator contacted to help operators find nodes to
start with.</p>
</div>
<div class="paragraph">
<p>Some common errors (likely culprit in parenthesis) assuming the client
has similar error names as the Datastax <code>drivers &lt;client-drivers&gt;</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SyntaxError</code> (<strong>client</strong>). This and other <code>QueryValidationException</code>
indicate that the client sent a malformed request. These are rarely
server issues and usually indicate bad queries.</p>
</li>
<li>
<p><code>UnavailableException</code> (<strong>server</strong>): This means that the Cassandra
coordinator node has rejected the query as it believes that insufficent
replica nodes are available. If many coordinators are throwing this
error it likely means that there really are (typically) multiple nodes
down in the cluster and you can identify them using <code>nodetool status
&lt;nodetool-status&gt;</code> If only a single coordinator is throwing this error
it may mean that node has been partitioned from the rest.</p>
</li>
<li>
<p><code>OperationTimedOutException</code> (<strong>server</strong>): This is the most frequent
timeout message raised when clients set timeouts and means that the
query took longer than the supplied timeout. This is a <em>client side</em>
timeout meaning that it took longer than the client specified timeout.
The error message will include the coordinator node that was last tried
which is usually a good starting point. This error usually indicates
either aggressive client timeout values or latent server
coordinators/replicas.</p>
</li>
<li>
<p><code>ReadTimeoutException</code> or <code>WriteTimeoutException</code> (<strong>server</strong>): These
are raised when clients do not specify lower timeouts and there is a
<em>coordinator</em> timeouts based on the values supplied in the
<code>cassandra.yaml</code> configuration file. They usually indicate a serious
server side problem as the default values are usually multiple seconds.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="metrics"><a class="anchor" href="#metrics"></a>Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you have Cassandra <code>metrics &lt;monitoring-metrics&gt;</code> reporting to a
centralized location such as <a href="https://graphiteapp.org/">Graphite</a> or
<a href="https://grafana.com/">Grafana</a> you can typically use those to narrow down
the problem. At this stage narrowing down the issue to a particular
datacenter, rack, or even group of nodes is the main goal. Some helpful
metrics to look at are:</p>
</div>
<div class="sect2">
<h3 id="errors"><a class="anchor" href="#errors"></a>Errors</h3>
<div class="paragraph">
<p>Cassandra refers to internode messaging errors as "drops", and provided
a number of <code>Dropped Message Metrics &lt;dropped-metrics&gt;</code> to help narrow
down errors. If particular nodes are dropping messages actively, they
are likely related to the issue.</p>
</div>
</div>
<div class="sect2">
<h3 id="latency"><a class="anchor" href="#latency"></a>Latency</h3>
<div class="paragraph">
<p>For timeouts or latency related issues you can start with <code>Table
Metrics &lt;table-metrics&gt;</code> by comparing Coordinator level metrics e.g.
<code>CoordinatorReadLatency</code> or <code>CoordinatorWriteLatency</code> with their
associated replica metrics e.g. <code>ReadLatency</code> or <code>WriteLatency</code>. Issues
usually show up on the <code>99th</code> percentile before they show up on the
<code>50th</code> percentile or the <code>mean</code>. While <code>maximum</code> coordinator latencies
are not typically very helpful due to the exponentially decaying
reservoir used internally to produce metrics, <code>maximum</code> replica
latencies that correlate with increased <code>99th</code> percentiles on
coordinators can help narrow down the problem.</p>
</div>
<div class="paragraph">
<p>There are usually three main possibilities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Coordinator latencies are high on all nodes, but only a few node&#8217;s
local read latencies are high. This points to slow replica nodes and the
coordinator&#8217;s are just side-effects. This usually happens when clients
are not token aware.</p>
</li>
<li>
<p>Coordinator latencies and replica latencies increase at the same time
on the a few nodes. If clients are token aware this is almost always
what happens and points to slow replicas of a subset of token ranges
(only part of the ring).</p>
</li>
<li>
<p>Coordinator and local latencies are high on many nodes. This usually
indicates either a tipping point in the cluster capacity (too many
writes or reads per second), or a new query pattern.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It&#8217;s important to remember that depending on the client&#8217;s load balancing
behavior and consistency levels coordinator and replica metrics may or
may not correlate. In particular if you use <code>TokenAware</code> policies the
same node&#8217;s coordinator and replica latencies will often increase
together, but if you just use normal <code>DCAwareRoundRobin</code> coordinator
latencies can increase with unrelated replica node&#8217;s latencies. For
example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>TokenAware</code> + <code>LOCAL_ONE</code>: should always have coordinator and replica
latencies on the same node rise together</p>
</li>
<li>
<p><code>TokenAware</code> + <code>LOCAL_QUORUM</code>: should always have coordinator and
multiple replica latencies rise together in the same datacenter.</p>
</li>
<li>
<p><code>TokenAware</code> + <code>QUORUM</code>: replica latencies in other datacenters can
affect coordinator latencies.</p>
</li>
<li>
<p><code>DCAwareRoundRobin</code> + <code>LOCAL_ONE</code>: coordinator latencies and unrelated
replica node&#8217;s latencies will rise together.</p>
</li>
<li>
<p><code>DCAwareRoundRobin</code> + <code>LOCAL_QUORUM</code>: different coordinator and
replica latencies will rise together with little correlation.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="query-rates"><a class="anchor" href="#query-rates"></a>Query Rates</h3>
<div class="paragraph">
<p>Sometimes the <code>Table &lt;table-metrics&gt;</code> query rate metrics can help narrow
down load issues as "small" increase in coordinator queries per second
(QPS) may correlate with a very large increase in replica level QPS.
This most often happens with <code>BATCH</code> writes, where a client may send a
single <code>BATCH</code> query that might contain 50 statements in it, which if
you have 9 copies (RF=3, three datacenters) means that every coordinator
<code>BATCH</code> write turns into 450 replica writes! This is why keeping
`BATCH&#8217;s to the same partition is so critical, otherwise you can
exhaust significant CPU capacitity with a "single" query.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="next-step-investigate-the-nodes"><a class="anchor" href="#next-step-investigate-the-nodes"></a>Next Step: Investigate the Node(s)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have narrowed down the problem as much as possible (datacenter,
rack , node), login to one of the nodes using SSH and proceed to debug
using <code>logs &lt;reading-logs&gt;</code>, <code>nodetool &lt;use-nodetool&gt;</code>, and
<code>os tools &lt;use-os-tools&gt;</code>. If you are not able to login you may still
have access to <code>logs &lt;reading-logs&gt;</code> and <code>nodetool &lt;use-nodetool&gt;</code>
remotely.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
