<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Security :: Apache Cassandra Documentation</title>
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Apache Cassandra Documentation&nbsp;&nbsp;&nbsp;<img src="../../../../_/img/cassandra_logo.png"></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Developer Mailing List</a>
            <a class="navbar-item" href="#">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ASCIIDOC_POC" data-version="4.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">ASCIIDOC_POC</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Cassandra Documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../new/index.html">What&#8217;s new</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../data_modeling/index.html">Data Modeling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="json.html">JSON</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="appendices.html">Appendices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/index.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operating/index.html">Operating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools/index.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/index.html">Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/index.html">Plug-ins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../faq/index.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ASCIIDOC_POC</span>
    <span class="version">4.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ASCIIDOC_POC</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">ASCIIDOC_POC</a></li>
    <li>Cassandra</li>
    <li>CQL</li>
    <li><a href="security.html">Security</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/cql/security.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Security</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>There are three main components to the security features provided by
Cassandra:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TLS/SSL encryption for client and inter-node communication</p>
</li>
<li>
<p>Client authentication</p>
</li>
<li>
<p>Authorization</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, these features are disabled as Cassandra is configured to
easily find and be found by other members of a cluster. In other words,
an out-of-the-box Cassandra installation presents a large attack surface
for a bad actor. Enabling authentication for clients using the binary
protocol is not sufficient to protect a cluster. Malicious users able to
access internode communication and JMX ports can still:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Craft internode messages to insert users into authentication schema</p>
</li>
<li>
<p>Craft internode messages to truncate or drop schema</p>
</li>
<li>
<p>Use tools such as <code>sstableloader</code> to overwrite <code>system_auth</code> tables</p>
</li>
<li>
<p>Attach to the cluster directly to capture write traffic</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Correct configuration of all three security components should negate
theses vectors. Therefore, understanding Cassandra&#8217;s security features
is crucial to configuring your cluster to meet your security needs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tlsssl-encryption"><a class="anchor" href="#tlsssl-encryption"></a>TLS/SSL Encryption</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra provides secure communication between a client machine and a
database cluster and between nodes within a cluster. Enabling encryption
ensures that data in flight is not compromised and is transferred
securely. The options for client-to-node and node-to-node encryption are
managed separately and may be configured independently.</p>
</div>
<div class="paragraph">
<p>In both cases, the JVM defaults for supported protocols and cipher
suites are used when encryption is enabled. These can be overidden using
the settings in <code>cassandra.yaml</code>, but this is not recommended unless
there are policies in place which dictate certain settings or a need to
disable vulnerable ciphers or protocols in cases where the JVM cannot be
updated.</p>
</div>
<div class="paragraph">
<p>FIPS compliant settings can be configured at the JVM level and should
not involve changing encryption settings in cassandra.yaml. See
<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/FIPS.html">the
java document on FIPS</a> for more details.</p>
</div>
<div class="paragraph">
<p>For information on generating the keystore and truststore files used in
SSL communications, see the
<a href="http://download.oracle.com/javase/6/docs/technotes/guides/security/jsse/JSSERefGuide.html#CreateKeystore">java
documentation on creating keystores</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ssl-certificate-hot-reloading"><a class="anchor" href="#ssl-certificate-hot-reloading"></a>SSL Certificate Hot Reloading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Beginning with Cassandra 4, Cassandra supports hot reloading of SSL
Certificates. If SSL/TLS support is enabled in Cassandra, the node
periodically polls the Trust and Key Stores specified in cassandra.yaml.
When the files are updated, Cassandra will reload them and use them for
subsequent connections. Please note that the Trust &amp; Key Store passwords
are part of the yaml so the updated files should also use the same
passwords. The default polling interval is 10 minutes.</p>
</div>
<div class="paragraph">
<p>Certificate Hot reloading may also be triggered using the
<code>nodetool reloadssl</code> command. Use this if you want to Cassandra to
immediately notice the changed certificates.</p>
</div>
<div class="sect2">
<h3 id="inter-node-encryption"><a class="anchor" href="#inter-node-encryption"></a>Inter-node Encryption</h3>
<div class="paragraph">
<p>The settings for managing inter-node encryption are found in
<code>cassandra.yaml</code> in the <code>server_encryption_options</code> section. To enable
inter-node encryption, change the <code>internode_encryption</code> setting from
its default value of <code>none</code> to one value from: <code>rack</code>, <code>dc</code> or <code>all</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="client-to-node-encryption"><a class="anchor" href="#client-to-node-encryption"></a>Client to Node Encryption</h3>
<div class="paragraph">
<p>The settings for managing client to node encryption are found in
<code>cassandra.yaml</code> in the <code>client_encryption_options</code> section. There are
two primary toggles here for enabling encryption, <code>enabled</code> and
<code>optional</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If neither is set to <code>true</code>, client connections are entirely
unencrypted.</p>
</li>
<li>
<p>If <code>enabled</code> is set to <code>true</code> and <code>optional</code> is set to <code>false</code>, all
client connections must be secured.</p>
</li>
<li>
<p>If both options are set to <code>true</code>, both encrypted and unencrypted
connections are supported using the same port. Client connections using
encryption with this configuration will be automatically detected and
handled by the server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As an alternative to the <code>optional</code> setting, separate ports can also be
configured for secure and unsecure connections where operational
requirements demand it. To do so, set <code>optional</code> to false and use the
<code>native_transport_port_ssl</code> setting in <code>cassandra.yaml</code> to specify the
port to be used for secure client communication.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="operation-roles"><a class="anchor" href="#operation-roles"></a>Roles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra uses database roles, which may represent either a single user
or a group of users, in both authentication and permissions management.
Role management is an extension point in Cassandra and may be configured
using the <code>role_manager</code> setting in <code>cassandra.yaml</code>. The default
setting uses <code>CassandraRoleManager</code>, an implementation which stores role
information in the tables of the <code>system_auth</code> keyspace.</p>
</div>
<div class="paragraph">
<p>See also the <code>CQL documentation on roles &lt;cql-roles&gt;</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication"><a class="anchor" href="#authentication"></a>Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authentication is pluggable in Cassandra and is configured using the
<code>authenticator</code> setting in <code>cassandra.yaml</code>. Cassandra ships with two
options included in the default distribution.</p>
</div>
<div class="paragraph">
<p>By default, Cassandra is configured with <code>AllowAllAuthenticator</code> which
performs no authentication checks and therefore requires no credentials.
It is used to disable authentication completely. Note that
authentication is a necessary condition of Cassandra&#8217;s permissions
subsystem, so if authentication is disabled, effectively so are
permissions.</p>
</div>
<div class="paragraph">
<p>The default distribution also includes <code>PasswordAuthenticator</code>, which
stores encrypted credentials in a system table. This can be used to
enable simple username/password authentication.</p>
</div>
<div class="sect2">
<h3 id="password-authentication"><a class="anchor" href="#password-authentication"></a>Enabling Password Authentication</h3>
<div class="paragraph">
<p>Before enabling client authentication on the cluster, client
applications should be pre-configured with their intended credentials.
When a connection is initiated, the server will only ask for credentials
once authentication is enabled, so setting up the client side config in
advance is safe. In contrast, as soon as a server has authentication
enabled, any connection attempt without proper credentials will be
rejected which may cause availability problems for client applications.
Once clients are setup and ready for authentication to be enabled,
follow this procedure to enable it on the cluster.</p>
</div>
<div class="paragraph">
<p>Pick a single node in the cluster on which to perform the initial
configuration. Ideally, no clients should connect to this node during
the setup process, so you may want to remove it from client config,
block it at the network level or possibly add a new temporary node to
the cluster for this purpose. On that node, perform the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a <code>cqlsh</code> session and change the replication factor of the
<code>system_auth</code> keyspace. By default, this keyspace uses
<code>SimpleReplicationStrategy</code> and a <code>replication_factor</code> of 1. It is
recommended to change this for any non-trivial deployment to ensure that
should nodes become unavailable, login is still possible. Best practice
is to configure a replication factor of 3 to 5 per-DC.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">ALTER KEYSPACE system_auth WITH replication = {'class': 'NetworkTopologyStrategy', 'DC1': 3, 'DC2': 3};</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Edit <code>cassandra.yaml</code> to change the <code>authenticator</code> option like so:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">authenticator: PasswordAuthenticator</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="3">
<li>
<p>Restart the node.</p>
</li>
<li>
<p>Open a new <code>cqlsh</code> session using the credentials of the default
superuser:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">cqlsh -u cassandra -p cassandra</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>During login, the credentials for the default superuser are read with
a consistency level of <code>QUORUM</code>, whereas those for all other users
(including superusers) are read at <code>LOCAL_ONE</code>. In the interests of
performance and availability, as well as security, operators should
create another superuser and disable the default one. This step is
optional, but highly recommended. While logged in as the default
superuser, create another superuser role which can be used to bootstrap
further configuration.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none"># create a new superuser
CREATE ROLE dba WITH SUPERUSER = true AND LOGIN = true AND PASSWORD = 'super';</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="6">
<li>
<p>Start a new cqlsh session, this time logging in as the new_superuser
and disable the default superuser.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">ALTER ROLE cassandra WITH SUPERUSER = false AND LOGIN = false;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="7">
<li>
<p>Finally, set up the roles and credentials for your application users
with <code>CREATE ROLE &lt;create-role-statement&gt;</code> statements.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>At the end of these steps, the one node is configured to use password
authentication. To roll that out across the cluster, repeat steps 2 and
3 on each node in the cluster. Once all nodes have been restarted,
authentication will be fully enabled throughout the cluster.</p>
</div>
<div class="paragraph">
<p>Note that using <code>PasswordAuthenticator</code> also requires the use of
<code>CassandraRoleManager &lt;operation-roles&gt;</code>.</p>
</div>
<div class="paragraph">
<p>See also: <code>setting-credentials-for-internal-authentication</code>,
<code>CREATE ROLE &lt;create-role-statement&gt;</code>,
<code>ALTER ROLE &lt;alter-role-statement&gt;</code>,
<code>ALTER KEYSPACE &lt;alter-keyspace-statement&gt;</code> and <code>GRANT PERMISSION
&lt;grant-permission-statement&gt;</code>,</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authorization"><a class="anchor" href="#authorization"></a>Authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Authorization is pluggable in Cassandra and is configured using the
<code>authorizer</code> setting in <code>cassandra.yaml</code>. Cassandra ships with two
options included in the default distribution.</p>
</div>
<div class="paragraph">
<p>By default, Cassandra is configured with <code>AllowAllAuthorizer</code> which
performs no checking and so effectively grants all permissions to all
roles. This must be used if <code>AllowAllAuthenticator</code> is the configured
authenticator.</p>
</div>
<div class="paragraph">
<p>The default distribution also includes <code>CassandraAuthorizer</code>, which does
implement full permissions management functionality and stores its data
in Cassandra system tables.</p>
</div>
<div class="sect2">
<h3 id="enabling-internal-authorization"><a class="anchor" href="#enabling-internal-authorization"></a>Enabling Internal Authorization</h3>
<div class="paragraph">
<p>Permissions are modelled as a whitelist, with the default assumption
that a given role has no access to any database resources. The
implication of this is that once authorization is enabled on a node, all
requests will be rejected until the required permissions have been
granted. For this reason, it is strongly recommended to perform the
initial setup on a node which is not processing client requests.</p>
</div>
<div class="paragraph">
<p>The following assumes that authentication has already been enabled via
the process outlined in <code>password-authentication</code>. Perform these steps
to enable internal authorization across the cluster:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>On the selected node, edit <code>cassandra.yaml</code> to change the <code>authorizer</code>
option like so:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">authorizer: CassandraAuthorizer</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="2">
<li>
<p>Restart the node.</p>
</li>
<li>
<p>Open a new <code>cqlsh</code> session using the credentials of a role with
superuser credentials:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">cqlsh -u dba -p super</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="4">
<li>
<p>Configure the appropriate access privileges for your clients using
<a href="cql.html#grant-permission">GRANT PERMISSION</a> statements. On the
other nodes, until configuration is updated and the node restarted, this
will have no effect so disruption to clients is avoided.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">GRANT SELECT ON ks.t1 TO db_user;</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic" start="5">
<li>
<p>Once all the necessary permissions have been granted, repeat steps 1
and 2 for each node in turn. As each node restarts and clients
reconnect, the enforcement of the granted permissions will begin.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See also: <code>GRANT PERMISSION &lt;grant-permission-statement&gt;</code>,
<span class="title-ref">GRANT ALL &lt;grant-all&gt;</span> and <code>REVOKE PERMISSION
&lt;revoke-permission-statement&gt;</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auth-caching"><a class="anchor" href="#auth-caching"></a>Caching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enabling authentication and authorization places additional load on the
cluster by frequently reading from the <code>system_auth</code> tables.
Furthermore, these reads are in the critical paths of many client
operations, and so has the potential to severely impact quality of
service. To mitigate this, auth data such as credentials, permissions
and role details are cached for a configurable period. The caching can
be configured (and even disabled) from <code>cassandra.yaml</code> or using a JMX
client. The JMX interface also supports invalidation of the various
caches, but any changes made via JMX are not persistent and will be
re-read from <code>cassandra.yaml</code> when the node is restarted.</p>
</div>
<div class="paragraph">
<p>Each cache has 3 options which can be set:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Validity Period</dt>
<dd>
<p>Controls the expiration of cache entries. After this period, entries
are invalidated and removed from the cache.</p>
</dd>
<dt class="hdlist1">Refresh Rate</dt>
<dd>
<p>Controls the rate at which background reads are performed to pick up
any changes to the underlying data. While these async refreshes are
performed, caches will continue to serve (possibly) stale data.
Typically, this will be set to a shorter time than the validity
period.</p>
</dd>
<dt class="hdlist1">Max Entries</dt>
<dd>
<p>Controls the upper bound on cache size.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The naming for these options in <code>cassandra.yaml</code> follows the convention:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;type&gt;_validity_in_ms</code></p>
</li>
<li>
<p><code>&lt;type&gt;_update_interval_in_ms</code></p>
</li>
<li>
<p><code>&lt;type&gt;_cache_max_entries</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Where <code>&lt;type&gt;</code> is one of <code>credentials</code>, <code>permissions</code>, or <code>roles</code>.</p>
</div>
<div class="paragraph">
<p>As mentioned, these are also exposed via JMX in the mbeans under the
<code>org.apache.cassandra.auth</code> domain.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="jmx-access"><a class="anchor" href="#jmx-access"></a>JMX access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Access control for JMX clients is configured separately to that for CQL.
For both authentication and authorization, two providers are available;
the first based on standard JMX security and the second which integrates
more closely with Cassandra&#8217;s own auth subsystem.</p>
</div>
<div class="paragraph">
<p>The default settings for Cassandra make JMX accessible only from
localhost. To enable remote JMX connections, edit <code>cassandra-env.sh</code> (or
<code>cassandra-env.ps1</code> on Windows) to change the <code>LOCAL_JMX</code> setting to
<code>no</code>. Under the standard configuration, when remote JMX connections are
enabled, <code>standard JMX authentication &lt;standard-jmx-auth&gt;</code> is also
switched on.</p>
</div>
<div class="paragraph">
<p>Note that by default, local-only connections are not subject to
authentication, but this can be enabled.</p>
</div>
<div class="paragraph">
<p>If enabling remote connections, it is recommended to also use
<code>SSL &lt;jmx-with-ssl&gt;</code> connections.</p>
</div>
<div class="paragraph">
<p>Finally, after enabling auth and/or SSL, ensure that tools which use
JMX, such as <code>nodetool &lt;nodetool&gt;</code>, are correctly configured and working
as expected.</p>
</div>
<div class="sect2">
<h3 id="standard-jmx-auth"><a class="anchor" href="#standard-jmx-auth"></a>Standard JMX Auth</h3>
<div class="paragraph">
<p>Users permitted to connect to the JMX server are specified in a simple
text file. The location of this file is set in <code>cassandra-env.sh</code> by the
line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Edit the password file to add username/password pairs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">jmx_user jmx_password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secure the credentials file so that only the user running the Cassandra
process can read it :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">$ chown cassandra:cassandra /etc/cassandra/jmxremote.password
$ chmod 400 /etc/cassandra/jmxremote.password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionally, enable access control to limit the scope of what defined
users can do via JMX. Note that this is a fairly blunt instrument in
this context as most operational tools in Cassandra require full
read/write access. To configure a simple access file, uncomment this
line in <code>cassandra-env.sh</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">#JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.access.file=/etc/cassandra/jmxremote.access"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then edit the access file to grant your JMX user readwrite permission:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">jmx_user readwrite</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cassandra must be restarted to pick up the new settings.</p>
</div>
<div class="paragraph">
<p>See also :
<a href="http://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.html#gdenv">Using
File-Based Password Authentication In JMX</a></p>
</div>
</div>
<div class="sect2">
<h3 id="cassandra-integrated-auth"><a class="anchor" href="#cassandra-integrated-auth"></a>Cassandra Integrated Auth</h3>
<div class="paragraph">
<p>An alternative to the out-of-the-box JMX auth is to useeCassandra&#8217;s own
authentication and/or authorization providers for JMX clients. This is
potentially more flexible and secure but it come with one major caveat.
Namely that it is not available until <span class="title-ref">after</span> a node has
joined the ring, because the auth subsystem is not fully configured
until that point However, it is often critical for monitoring purposes
to have JMX access particularly during bootstrap. So it is recommended,
where possible, to use local only JMX auth during bootstrap and then, if
remote connectivity is required, to switch to integrated auth once the
node has joined the ring and initial setup is complete.</p>
</div>
<div class="paragraph">
<p>With this option, the same database roles used for CQL authentication
can be used to control access to JMX, so updates can be managed
centrally using just <code>cqlsh</code>. Furthermore, fine grained control over
exactly which operations are permitted on particular MBeans can be
acheived via <code>GRANT PERMISSION &lt;grant-permission-statement&gt;</code>.</p>
</div>
<div class="paragraph">
<p>To enable integrated authentication, edit <code>cassandra-env.sh</code> to
uncomment these lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">#JVM_OPTS="$JVM_OPTS -Dcassandra.jmx.remote.login.config=CassandraLogin"
#JVM_OPTS="$JVM_OPTS -Djava.security.auth.login.config=$CASSANDRA_HOME/conf/cassandra-jaas.config"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And disable the JMX standard auth by commenting this line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable integrated authorization, uncomment this line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">#JVM_OPTS="$JVM_OPTS -Dcassandra.jmx.authorizer=org.apache.cassandra.auth.jmx.AuthorizationProxy"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check standard access control is off by ensuring this line is commented
out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">#JVM_OPTS="$JVM_OPTS -Dcom.sun.management.jmxremote.access.file=/etc/cassandra/jmxremote.access"</code></pre>
</div>
</div>
<div class="paragraph">
<p>With integrated authentication and authorization enabled, operators can
define specific roles and grant them access to the particular JMX
resources that they need. For example, a role with the necessary
permissions to use tools such as jconsole or jmc in read-only mode would
be defined as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">CREATE ROLE jmx WITH LOGIN = false;
GRANT SELECT ON ALL MBEANS TO jmx;
GRANT DESCRIBE ON ALL MBEANS TO jmx;
GRANT EXECUTE ON MBEAN 'java.lang:type=Threading' TO jmx;
GRANT EXECUTE ON MBEAN 'com.sun.management:type=HotSpotDiagnostic' TO jmx;

# Grant the role with necessary permissions to use nodetool commands (including nodetool status) in read-only mode
GRANT EXECUTE ON MBEAN 'org.apache.cassandra.db:type=EndpointSnitchInfo' TO jmx;
GRANT EXECUTE ON MBEAN 'org.apache.cassandra.db:type=StorageService' TO jmx;

# Grant the jmx role to one with login permissions so that it can access the JMX tooling
CREATE ROLE ks_user WITH PASSWORD = 'password' AND LOGIN = true AND SUPERUSER = false;
GRANT jmx TO ks_user;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fine grained access control to individual MBeans is also supported:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">GRANT EXECUTE ON MBEAN 'org.apache.cassandra.db:type=Tables,keyspace=test_keyspace,table=t1' TO ks_user;
GRANT EXECUTE ON MBEAN 'org.apache.cassandra.db:type=Tables,keyspace=test_keyspace,table=*' TO ks_owner;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This permits the <code>ks_user</code> role to invoke methods on the MBean
representing a single table in <code>test_keyspace</code>, while granting the same
permission for all table level MBeans in that keyspace to the <code>ks_owner</code>
role.</p>
</div>
<div class="paragraph">
<p>Adding/removing roles and granting/revoking of permissions is handled
dynamically once the initial setup is complete, so no further restarts
are required if permissions are altered.</p>
</div>
<div class="paragraph">
<p>See also: <code>Permissions &lt;cql-permissions&gt;</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="jmx-with-ssl"><a class="anchor" href="#jmx-with-ssl"></a>JMX With SSL</h3>
<div class="paragraph">
<p>JMX SSL configuration is controlled by a number of system properties,
some of which are optional. To turn on SSL, edit the relevant lines in
<code>cassandra-env.sh</code> (or <code>cassandra-env.ps1</code> on Windows) to uncomment and
set the values of these properties as required:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>com.sun.management.jmxremote.ssl</code></dt>
<dd>
<p>set to true to enable SSL</p>
</dd>
<dt class="hdlist1"><code>com.sun.management.jmxremote.ssl.need.client.auth</code></dt>
<dd>
<p>set to true to enable validation of client certificates</p>
</dd>
<dt class="hdlist1"><code>com.sun.management.jmxremote.registry.ssl</code></dt>
<dd>
<p>enables SSL sockets for the RMI registry from which clients obtain the
JMX connector stub</p>
</dd>
<dt class="hdlist1"><code>com.sun.management.jmxremote.ssl.enabled.protocols</code></dt>
<dd>
<p>by default, the protocols supported by the JVM will be used, override
with a comma-separated list. Note that this is not usually necessary
and using the defaults is the preferred option.</p>
</dd>
<dt class="hdlist1"><code>com.sun.management.jmxremote.ssl.enabled.cipher.suites</code></dt>
<dd>
<p>by default, the cipher suites supported by the JVM will be used,
override with a comma-separated list. Note that this is not usually
necessary and using the defaults is the preferred option.</p>
</dd>
<dt class="hdlist1"><code>javax.net.ssl.keyStore</code></dt>
<dd>
<p>set the path on the local filesystem of the keystore containing server
private keys and public certificates</p>
</dd>
<dt class="hdlist1"><code>javax.net.ssl.keyStorePassword</code></dt>
<dd>
<p>set the password of the keystore file</p>
</dd>
<dt class="hdlist1"><code>javax.net.ssl.trustStore</code></dt>
<dd>
<p>if validation of client certificates is required, use this property to
specify the path of the truststore containing the public certificates
of trusted clients</p>
</dd>
<dt class="hdlist1"><code>javax.net.ssl.trustStorePassword</code></dt>
<dd>
<p>set the password of the truststore file</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>See also:
<a href="http://docs.oracle.com/javase/7/docs/technotes/guides/management/agent.html#gdemv">Oracle
Java7 Docs</a>,
<a href="https://www.lullabot.com/articles/monitor-java-with-jmx">Monitor Java
with JMX</a></p>
</div>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
