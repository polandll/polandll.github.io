<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Adding, replacing, moving and removing nodes :: Apache Cassandra Documentation</title>
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Apache Cassandra Documentation&nbsp;&nbsp;&nbsp;<img src="../../../../_/img/cassandra_logo.png"></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Developer Mailing List</a>
            <a class="navbar-item" href="#">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ASCIIDOC_POC" data-version="4.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">ASCIIDOC_POC</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Cassandra Documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../new/index.html">What&#8217;s new</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../data_modeling/index.html">Data Modeling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/appendices.html">Appendices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/index.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">Operating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools/index.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/index.html">Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/index.html">Plug-ins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../faq/index.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ASCIIDOC_POC</span>
    <span class="version">4.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ASCIIDOC_POC</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">ASCIIDOC_POC</a></li>
    <li><a href="topo_changes.html">Adding, replacing, moving and removing nodes</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/operating/topo_changes.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Adding, replacing, moving and removing nodes</h1>
<div class="sect1">
<h2 id="bootstrap"><a class="anchor" href="#bootstrap"></a>Bootstrap</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Adding new nodes is called "bootstrapping". The <code>num_tokens</code> parameter
will define the amount of virtual nodes (tokens) the joining node will
be assigned during bootstrap. The tokens define the sections of the ring
(token ranges) the node will become responsible for.</p>
</div>
<div class="sect2">
<h3 id="token-allocation"><a class="anchor" href="#token-allocation"></a>Token allocation</h3>
<div class="paragraph">
<p>With the default token allocation algorithm the new node will pick
<code>num_tokens</code> random tokens to become responsible for. Since tokens are
distributed randomly, load distribution improves with a higher amount of
virtual nodes, but it also increases token management overhead. The
default of 256 virtual nodes should provide a reasonable load balance
with acceptable overhead.</p>
</div>
<div class="paragraph">
<p>On 3.0+ a new token allocation algorithm was introduced to allocate
tokens based on the load of existing virtual nodes for a given keyspace,
and thus yield an improved load distribution with a lower number of
tokens. To use this approach, the new node must be started with the JVM
option <code>-Dcassandra.allocate_tokens_for_keyspace=&lt;keyspace&gt;</code>, where
<code>&lt;keyspace&gt;</code> is the keyspace from which the algorithm can find the load
information to optimize token assignment for.</p>
</div>
<div class="sect3">
<h4 id="manual-token-assignment"><a class="anchor" href="#manual-token-assignment"></a>Manual token assignment</h4>
<div class="paragraph">
<p>You may specify a comma-separated list of tokens manually with the
<code>initial_token</code> <code>cassandra.yaml</code> parameter, and if that is specified
Cassandra will skip the token allocation process. This may be useful
when doing token assignment with an external tool or when restoring a
node with its previous tokens.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="range-streaming"><a class="anchor" href="#range-streaming"></a>Range streaming</h3>
<div class="paragraph">
<p>After the tokens are allocated, the joining node will pick current
replicas of the token ranges it will become responsible for to stream
data from. By default it will stream from the primary replica of each
token range in order to guarantee data in the new node will be
consistent with the current state.</p>
</div>
<div class="paragraph">
<p>In the case of any unavailable replica, the consistent bootstrap process
will fail. To override this behavior and potentially miss data from an
unavailable replica, set the JVM flag
<code>-Dcassandra.consistent.rangemovement=false</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="resuming-failedhanged-bootstrap"><a class="anchor" href="#resuming-failedhanged-bootstrap"></a>Resuming failed/hanged bootstrap</h3>
<div class="paragraph">
<p>On 2.2+, if the bootstrap process fails, it&#8217;s possible to resume
bootstrap from the previous saved state by calling
<code>nodetool bootstrap resume</code>. If for some reason the bootstrap hangs or
stalls, it may also be resumed by simply restarting the node. In order
to cleanup bootstrap state and start fresh, you may set the JVM startup
flag <code>-Dcassandra.reset_bootstrap_progress=true</code>.</p>
</div>
<div class="paragraph">
<p>On lower versions, when the bootstrap proces fails it is recommended to
wipe the node (remove all the data), and restart the bootstrap process
again.</p>
</div>
</div>
<div class="sect2">
<h3 id="manual-bootstrapping"><a class="anchor" href="#manual-bootstrapping"></a>Manual bootstrapping</h3>
<div class="paragraph">
<p>It&#8217;s possible to skip the bootstrapping process entirely and join the
ring straight away by setting the hidden parameter
<code>auto_bootstrap: false</code>. This may be useful when restoring a node from a
backup or creating a new data-center.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="removing-nodes"><a class="anchor" href="#removing-nodes"></a>Removing nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can take a node out of the cluster with <code>nodetool decommission</code> to a
live node, or <code>nodetool removenode</code> (to any other machine) to remove a
dead one. This will assign the ranges the old node was responsible for
to other nodes, and replicate the appropriate data there. If
decommission is used, the data will stream from the decommissioned node.
If removenode is used, the data will stream from the remaining replicas.</p>
</div>
<div class="paragraph">
<p>No data is removed automatically from the node being decommissioned, so
if you want to put the node back into service at a different token on
the ring, it should be removed manually.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="moving-nodes"><a class="anchor" href="#moving-nodes"></a>Moving nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When <code>num_tokens: 1</code> it&#8217;s possible to move the node position in the ring
with <code>nodetool move</code>. Moving is both a convenience over and more
efficient than decommission + bootstrap. After moving a node,
<code>nodetool cleanup</code> should be run to remove any unnecessary data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="replacing-a-dead-node"><a class="anchor" href="#replacing-a-dead-node"></a>Replacing a dead node</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to replace a dead node, start cassandra with the JVM startup
flag <code>-Dcassandra.replace_address_first_boot=&lt;dead_node_ip&gt;</code>. Once this
property is enabled the node starts in a hibernate state, during which
all the other nodes will see this node to be DOWN (DN), however this
node will see itself as UP (UN). Accurate replacement state can be found
in <code>nodetool netstats</code>.</p>
</div>
<div class="paragraph">
<p>The replacing node will now start to bootstrap the data from the rest of
the nodes in the cluster. A replacing node will only receive writes
during the bootstrapping phase if it has a different ip address to the
node that is being replaced. (See CASSANDRA-8523 and CASSANDRA-12344)</p>
</div>
<div class="paragraph">
<p>Once the bootstrapping is complete the node will be marked "UP".</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Note</div>
<div class="paragraph">
<p>If any of the following cases apply, you <strong>MUST</strong> run repair to make the
replaced node consistent again, since it missed ongoing writes
during/prior to bootstrapping. The <em>replacement</em> timeframe refers to the
period from when the node initially dies to when a new node completes
the replacement process.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The node is down for longer than <code>max_hint_window_in_ms</code> before being
replaced.</p>
</li>
<li>
<p>You are replacing using the same IP address as the dead node <strong>and</strong>
replacement takes longer than <code>max_hint_window_in_ms</code>.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitoring-progress"><a class="anchor" href="#monitoring-progress"></a>Monitoring progress</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bootstrap, replace, move and remove progress can be monitored using
<code>nodetool netstats</code> which will show the progress of the streaming
operations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cleanup-data-after-range-movements"><a class="anchor" href="#cleanup-data-after-range-movements"></a>Cleanup data after range movements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As a safety measure, Cassandra does not automatically remove data from
nodes that "lose" part of their token range due to a range movement
operation (bootstrap, move, replace). Run <code>nodetool cleanup</code> on the
nodes that lost ranges to the joining node when you are satisfied the
new node is up and working. If you do not do this the old data will
still be counted against the load on that node.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
