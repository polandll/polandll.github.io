<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Improved Internode Messaging :: Apache Cassandra Documentation</title>
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Apache Cassandra Documentation&nbsp;&nbsp;&nbsp;<img src="../../../../_/img/cassandra_logo.png"></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Latest</a>
            <a class="navbar-item" href="#">3.x</a>
            <a class="navbar-item" href="#">3.0</a>
            <a class="navbar-item" href="#">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Developer Mailing List</a>
            <a class="navbar-item" href="#">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="ASCIIDOC_POC" data-version="4.0">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">ASCIIDOC_POC</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Cassandra Documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="index.html">What&#8217;s new</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../data_modeling/index.html">Data Modeling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/changes.html">Changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/appendices.html">Appendices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/index.html">Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../operating/index.html">Operating</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tools/index.html">Tools</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../development/index.html">Development</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/index.html">Plug-ins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../faq/index.html">FAQ</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">ASCIIDOC_POC</span>
    <span class="version">4.0</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">ASCIIDOC_POC</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">4.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">ASCIIDOC_POC</a></li>
    <li><a href="messaging.html">Improved Internode Messaging</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/new/messaging.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Improved Internode Messaging</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Apache Cassandra 4.0 has added several new improvements to internode
messaging.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="optimized-internode-messaging-protocol"><a class="anchor" href="#optimized-internode-messaging-protocol"></a>Optimized Internode Messaging Protocol</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The internode messaging protocol has been optimized
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-14485">CASSANDRA-14485</a>).
Previously the <code>IPAddressAndPort</code> of the sender was included with each
message that was sent even though the <code>IPAddressAndPort</code> had already
been sent once when the initial connection/session was established. In
Cassandra 4.0 <code>IPAddressAndPort</code> has been removed from every separate
message sent and only sent when connection/session is initiated.</p>
</div>
<div class="paragraph">
<p>Another improvement is that at several instances (listed) a fixed 4-byte
integer value has been replaced with <code>vint</code> as a <code>vint</code> is almost always
less than 1 byte:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>paramSize</code> (the number of parameters in the header)</p>
</li>
<li>
<p>Each individual parameter value</p>
</li>
<li>
<p>The <code>payloadSize</code></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nio-messaging"><a class="anchor" href="#nio-messaging"></a>NIO Messaging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Cassandra 4.0 peer-to-peer (internode) messaging has been switched to
non-blocking I/O (NIO) via Netty
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-8457">CASSANDRA-8457</a>).</p>
</div>
<div class="paragraph">
<p>As serialization format, each message contains a header with several
fixed fields, an optional key-value parameters section, and then the
message payload itself. Note: the IP address in the header may be either
IPv4 (4 bytes) or IPv6 (16 bytes).</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The diagram below shows the IPv4 address for brevity.</p>
</div>
</blockquote>
</div>
<div class="literalblock">
<div class="content">
<pre>1 1 1 1 1 2 2 2 2 2 3 3 3 3 3 4 4 4 4 4 5 5 5 5 5 6 6
0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2 4 6 8 0 2
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                       PROTOCOL MAGIC                          |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Message ID                            |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                         Timestamp                             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Addr len |           IP Address (IPv4)                       /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
/           |                 Verb                              /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
/           |            Parameters size                        /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
/           |             Parameter data                        /
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
/                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Payload size                           |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                                                               /
/                           Payload                             /
/                                                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</pre>
</div>
</div>
<div class="paragraph">
<p>An individual parameter has a String key and a byte array value. The key
is serialized with its length, encoded as two bytes, followed by the
UTF-8 byte encoding of the string. The body is serialized with its
length, encoded as four bytes, followed by the bytes of the value.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resource-limits-on-queued-messages"><a class="anchor" href="#resource-limits-on-queued-messages"></a>Resource limits on Queued Messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>System stability is improved by enforcing strict resource limits
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-15066">CASSANDRA-15066</a>)
on the number of outbound messages that are queued, measured by the
<code>serializedSize</code> of the message. There are three separate limits imposed
simultaneously to ensure that progress is always made without any
reasonable combination of failures impacting a node’s stability.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Global, per-endpoint and per-connection limits are imposed on messages
queued for delivery to other nodes and waiting to be processed on
arrival from other nodes in the cluster. These limits are applied to the
on-wire size of the message being sent or received.</p>
</li>
<li>
<p>The basic per-link limit is consumed in isolation before any endpoint
or global limit is imposed. Each node-pair has three links: urgent,
small and large. So any given node may have a maximum of
<code>N*3 * (internode_application_send_queue_capacity_in_bytes + internode_application_receive_queue_capacity_in_bytes)</code>
messages queued without any coordination between them although in
practice, with token-aware routing, only RF*tokens nodes should need to
communicate with significant bandwidth.</p>
</li>
<li>
<p>The per-endpoint limit is imposed on all messages exceeding the
per-link limit, simultaneously with the global limit, on all links to or
from a single node in the cluster. The global limit is imposed on all
messages exceeding the per-link limit, simultaneously with the
per-endpoint limit, on all links to or from any node in the cluster. The
following configuration settings have been added to <code>cassandra.yaml</code> for
resource limits on queued messages.</p>
</li>
</ol>
</div>
<div class="literalblock">
<div class="content">
<pre>internode_application_send_queue_capacity_in_bytes: 4194304 #4MiB
internode_application_send_queue_reserve_endpoint_capacity_in_bytes: 134217728  #128MiB
internode_application_send_queue_reserve_global_capacity_in_bytes: 536870912    #512MiB
internode_application_receive_queue_capacity_in_bytes: 4194304                  #4MiB
internode_application_receive_queue_reserve_endpoint_capacity_in_bytes: 134217728 #128MiB
internode_application_receive_queue_reserve_global_capacity_in_bytes: 536870912   #512MiB</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="virtual-tables-for-messaging-metrics"><a class="anchor" href="#virtual-tables-for-messaging-metrics"></a>Virtual Tables for Messaging Metrics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Metrics is improved by keeping metrics using virtual tables for
inter-node inbound and outbound messaging
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-15066">CASSANDRA-15066</a>).
For inbound messaging a virtual table (<code>internode_inbound</code>) has been
added to keep metrics for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bytes and count of messages that could not be serialized or flushed
due to an error</p>
</li>
<li>
<p>Bytes and count of messages scheduled</p>
</li>
<li>
<p>Bytes and count of messages successfully processed</p>
</li>
<li>
<p>Bytes and count of messages successfully received</p>
</li>
<li>
<p>Nanos and count of messages throttled</p>
</li>
<li>
<p>Bytes and count of messages expired</p>
</li>
<li>
<p>Corrupt frames recovered and unrecovered</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A separate virtual table (<code>internode_outbound</code>) has been added for
outbound inter-node messaging. The outbound virtual table keeps metrics
for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bytes and count of messages pending</p>
</li>
<li>
<p>Bytes and count of messages sent</p>
</li>
<li>
<p>Bytes and count of messages expired</p>
</li>
<li>
<p>Bytes and count of messages that could not be sent due to an error</p>
</li>
<li>
<p>Bytes and count of messages overloaded</p>
</li>
<li>
<p>Active Connection Count</p>
</li>
<li>
<p>Connection Attempts</p>
</li>
<li>
<p>Successful Connection Attempts</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hint-messaging"><a class="anchor" href="#hint-messaging"></a>Hint Messaging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A specialized version of hint message that takes an already encoded in a
<code>ByteBuffer</code> hint and sends it verbatim has been added. It is an
optimization for when dispatching a hint file of the current messaging
version to a node of the same messaging version, which is the most
common case. It saves on extra <code>ByteBuffer</code> allocations one redundant
hint deserialization-serialization cycle.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="internode-application-timeout"><a class="anchor" href="#internode-application-timeout"></a>Internode Application Timeout</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A configuration setting has been added to <code>cassandra.yaml</code> for the
maximum continuous period a connection may be unwritable in application
space.</p>
</div>
<div class="literalblock">
<div class="content">
<pre># internode_application_timeout_in_ms = 30000</pre>
</div>
</div>
<div class="paragraph">
<p>Some other new features include logging of message size to trace message
for tracing a query.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="paxos-prepare-and-propose-stage-for-local-requests-optimized"><a class="anchor" href="#paxos-prepare-and-propose-stage-for-local-requests-optimized"></a>Paxos prepare and propose stage for local requests optimized</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In pre-4.0 Paxos prepare and propose messages always go through entire
<code>MessagingService</code> stack in Cassandra even if request is to be served
locally, we can enhance and make local requests severed w/o involving
<code>MessagingService</code>. Similar things are done elsewhere in Cassandra which
skips <code>MessagingService</code> stage for local requests.</p>
</div>
<div class="paragraph">
<p>This is what it looks like in pre 4.0 if we have tracing on and run a
light-weight transaction:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Sending PAXOS_PREPARE message to /A.B.C.D [MessagingService-Outgoing-/A.B.C.D] | 2017-09-11
21:55:18.971000 | A.B.C.D | 15045
… REQUEST_RESPONSE message received from /A.B.C.D [MessagingService-Incoming-/A.B.C.D] |
2017-09-11 21:55:18.976000 | A.B.C.D | 20270
… Processing response from /A.B.C.D [SharedPool-Worker-4] | 2017-09-11 21:55:18.976000 |
A.B.C.D | 20372</pre>
</div>
</div>
<div class="paragraph">
<p>Same thing applies for Propose stage as well.</p>
</div>
<div class="paragraph">
<p>In version 4.0 Paxos prepare and propose stage for local requests are
optimized
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-13862">CASSANDRA-13862</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="quality-assurance"><a class="anchor" href="#quality-assurance"></a>Quality Assurance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Several other quality assurance improvements have been made in version
4.0
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-15066">CASSANDRA-15066</a>).</p>
</div>
<div class="sect2">
<h3 id="framing"><a class="anchor" href="#framing"></a>Framing</h3>
<div class="paragraph">
<p>Version 4.0 introduces framing to all internode messages, i.e. the
grouping of messages into a single logical payload with headers and
trailers; these frames are guaranteed to either contain at most one
message, that is split into its own unique sequence of frames (for large
messages), or that a frame contains only complete messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="corruption-prevention"><a class="anchor" href="#corruption-prevention"></a>Corruption prevention</h3>
<div class="paragraph">
<p>Previously, intra-datacenter internode messages would be unprotected
from corruption by default, as only LZ4 provided any integrity checks.
All messages to post 4.0 nodes are written to explicit frames, which may
be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>LZ4 encoded</p>
</li>
<li>
<p>CRC protected</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Unprotected option is still available.</p>
</div>
</div>
<div class="sect2">
<h3 id="resilience"><a class="anchor" href="#resilience"></a>Resilience</h3>
<div class="paragraph">
<p>For resilience, all frames are written with a separate CRC protected
header, of 8 and 6 bytes respectively. If corruption occurs in this
header, the connection must be reset, as before. If corruption occurs
anywhere outside of the header, the corrupt frame will be skipped,
leaving the connection intact and avoiding the loss of any messages
unnecessarily.</p>
</div>
<div class="paragraph">
<p>Previously, any issue at any point in the stream would result in the
connection being reset, with the loss of any in-flight messages.</p>
</div>
</div>
<div class="sect2">
<h3 id="efficiency"><a class="anchor" href="#efficiency"></a>Efficiency</h3>
<div class="paragraph">
<p>The overall memory usage, and number of byte shuffles, on both inbound
and outbound messages is reduced.</p>
</div>
<div class="paragraph">
<p>Outbound the Netty LZ4 encoder maintains a chunk size buffer (64KiB),
that is filled before any compressed frame can be produced. Our frame
encoders avoid this redundant copy, as well as freeing 192KiB per
endpoint.</p>
</div>
<div class="paragraph">
<p>Inbound, frame decoders guarantee only to copy the number of bytes
necessary to parse a frame, and to never store more bytes than
necessary. This improvement applies twice to LZ4 connections, improving
both the message decode and the LZ4 frame decode.</p>
</div>
</div>
<div class="sect2">
<h3 id="inbound-path"><a class="anchor" href="#inbound-path"></a>Inbound Path</h3>
<div class="paragraph">
<p>Version 4.0 introduces several improvements to the inbound path.</p>
</div>
<div class="paragraph">
<p>An appropriate message handler is used based on whether large or small
messages are expected on a particular connection as set in a flag.
<code>NonblockingBufferHandler</code>, running on event loop, is used for small
messages, and <code>BlockingBufferHandler</code>, running off event loop, for large
messages. The single implementation of <code>InboundMessageHandler</code> handles
messages of any size effectively by deriving size of the incoming
message from the byte stream. In addition to deriving size of the
message from the stream, incoming message expiration time is proactively
read, before attempting to deserialize the entire message. If it’s
expired at the time when a message is encountered the message is just
skipped in the byte stream altogether. And if a message fails to be
deserialized while still on the receiving side - say, because of table
id or column being unknown - bytes are skipped, without dropping the
entire connection and losing all the buffered messages. An immediately
reply back is sent to the coordinator node with the failure reason,
rather than waiting for the coordinator callback to expire. This logic
is extended to a corrupted frame; a corrupted frame is safely skipped
over without dropping the connection.</p>
</div>
<div class="paragraph">
<p>Inbound path imposes strict limits on memory utilization. Specifically,
the memory occupied by all parsed, but unprocessed messages is bound -
on per-connection, per-endpoint, and global basis. Once a connection
exceeds its local unprocessed capacity and cannot borrow any permits
from per-endpoint and global reserve, it simply stops processing further
messages, providing natural backpressure - until sufficient capacity is
regained.</p>
</div>
</div>
<div class="sect2">
<h3 id="outbound-connections"><a class="anchor" href="#outbound-connections"></a>Outbound Connections</h3>
<div class="sect3">
<h4 id="opening-a-connection"><a class="anchor" href="#opening-a-connection"></a>Opening a connection</h4>
<div class="paragraph">
<p>A consistent approach is adopted for all kinds of failure to connect,
including: refused by endpoint, incompatible versions, or unexpected
exceptions;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Retry forever, until either success or no messages waiting to deliver.</p>
</li>
<li>
<p>Wait incrementally longer periods before reconnecting, up to a maximum
of 1s.</p>
</li>
<li>
<p>While failing to connect, no reserve queue limits are acquired.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="closing-a-connection"><a class="anchor" href="#closing-a-connection"></a>Closing a connection</h4>
<div class="ulist">
<ul>
<li>
<p>Correctly drains outbound messages that are waiting to be delivered
(unless disconnected and fail to reconnect).</p>
</li>
<li>
<p>Messages written to a closing connection are either delivered or
rejected, with a new connection being opened if the old is irrevocably
closed.</p>
</li>
<li>
<p>Unused connections are pruned eventually.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="reconnecting"><a class="anchor" href="#reconnecting"></a>Reconnecting</h4>
<div class="paragraph">
<p>We sometimes need to reconnect a perfectly valid connection, e.g. if the
preferred IP address changes. We ensure that the underlying connection
has no in-progress operations before closing it and reconnecting.</p>
</div>
</div>
<div class="sect3">
<h4 id="message-failure"><a class="anchor" href="#message-failure"></a>Message Failure</h4>
<div class="paragraph">
<p>Propagates to callbacks instantly, better preventing overload by
reclaiming committed memory.</p>
</div>
<div class="sect4">
<h5 id="expiry"><a class="anchor" href="#expiry"></a>Expiry</h5>
<div class="ulist">
<ul>
<li>
<p>No longer experiences head-of-line blocking (e.g. undroppable message
preventing all droppable messages from being expired).</p>
</li>
<li>
<p>While overloaded, expiry is attempted eagerly on enqueuing threads.</p>
</li>
<li>
<p>While disconnected we schedule regular pruning, to handle the case
where messages are no longer being sent, but we have a large backlog to
expire.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="overload"><a class="anchor" href="#overload"></a>Overload</h5>
<div class="ulist">
<ul>
<li>
<p>Tracked by bytes queued, as opposed to number of messages.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="serialization-errors"><a class="anchor" href="#serialization-errors"></a>Serialization Errors</h5>
<div class="ulist">
<ul>
<li>
<p>Do not result in the connection being invalidated; the message is
simply completed with failure, and then erased from the frame.</p>
</li>
<li>
<p>Includes detected mismatch between calculated serialization size to
actual.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Failures to flush to network, perhaps because the connection has been
reset are not currently notified to callback handlers, as the necessary
information has been discarded, though it would be possible to do so in
future if we decide it is worth our while.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="qos"><a class="anchor" href="#qos"></a>QoS</h4>
<div class="paragraph">
<p>"Gossip" connection has been replaced with a general purpose "Urgent"
connection, for any small messages impacting system stability.</p>
</div>
</div>
<div class="sect3">
<h4 id="metrics"><a class="anchor" href="#metrics"></a>Metrics</h4>
<div class="paragraph">
<p>We track, and expose via Virtual Table and JMX, the number of messages
and bytes that: we could not serialize or flush due to an error, we
dropped due to overload or timeout, are pending, and have successfully
sent.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="added-a-message-size-limit"><a class="anchor" href="#added-a-message-size-limit"></a>Added a Message size limit</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra pre-4.0 doesn&#8217;t protect the server from allocating huge
buffers for the inter-node Message objects. Adding a message size limit
would be good to deal with issues such as a malfunctioning cluster
participant. Version 4.0 introduced max message size config param, akin
to max mutation size - set to endpoint reserve capacity by default.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="recover-from-unknown-table-when-deserializing-internode-messages"><a class="anchor" href="#recover-from-unknown-table-when-deserializing-internode-messages"></a>Recover from unknown table when deserializing internode messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As discussed in
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-9289">CASSANDRA-9289</a>)
it would be nice to gracefully recover from seeing an unknown table in a
message from another node. Pre-4.0, we close the connection and
reconnect, which can cause other concurrent queries to fail. Version 4.0
fixes the issue by wrapping message in-stream with
<code>TrackedDataInputPlus</code>, catching <code>UnknownCFException</code>, and skipping the
remaining bytes in this message. TCP won&#8217;t be closed and it will remain
connected for other messages.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
