<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Read repair :: Apache Cassandra Documentation</title>
    <link rel="canonical" href="file:///Users/lorina.poland/docs-site/build/site/Cassandra/4.0/Cassandra/3.11/cassandra/operating/read_repair.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="file:///Users/lorina.poland/docs-site/build/site/Cassandra/4.0">&nbsp;&nbsp;&nbsp;<img src="../../../../_/img/cassandra_logo.png"></a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://cassandra.apache.org">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/download/">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/3.11.6/apache-cassandra-3.11.6-bin.tar.gz">Latest</a>
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/3.11.6/apache-cassandra-3.11.6-bin.tar.gz">3.x</a>
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/3.0.20/apache-cassandra-3.0.20-bin.tar.gz">3.0</a>
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/2.1.21/apache-cassandra-2.1.21-bin.tar.gz">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/doc/">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://cassandra.apache.org/doc/">Latest</a>
            <a class="navbar-item" href="">3.x</a>
            <a class="navbar-item" href="https://cassandra.apache.org/doc/old/CQL-3.0.html">3.0</a>
            <a class="navbar-item" href="https://cassandra.apache.org/doc/old/CQL-2.1.html">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/community/">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://lists.apache.org/list.html?dev@cassandra.apache.org">Developer Mailing List</a>
            <a class="navbar-item" href="https://lists.apache.org/list.html?user@cassandra.apache.org">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/blog/">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
  <nav class="navbar2">
    <div class="navbar2-brand">
      <a class="navbar2-item href="https://asf.org"><img src="../../../../_/img/asf_feather.png" height="70%">&nbsp;&nbsp;&nbsp;Apache Software Foundation / Apache Cassandra</a>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="Cassandra" data-version="3.11">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Cassandra</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../index.html">Main</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../new/index.html">What&#8217;s new</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/java11.html">Support for Java 11</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/virtualtables.html">Virtual tables</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/auditlogging.html">Audit logging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/fqllogging.html">Full query logging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/messaging.html">Improved internode Messaging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/streaming.html">Improved streaming</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../new/transientreplication.html">Transient replication</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../data_modeling/index.html">Data modeling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_conceptual.html">Conceptual data modeling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_rdbms.html">RDBMS design</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_queries.html">Defining application queries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_logical.html">Logical data modeling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_physical.html">Physical data modeling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_refining.html">Evaluating and refining data models</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_schema.html">Defining database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../data_modeling/data_modeling_tools.html">Cassandra data modeling tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/appendices.html">Appendices</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cql/changes.html">Changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../configuration/index.html">Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_yaml_file.html">cassandra.yaml</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_rackdc_file.html">cassandra-rackdc.properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_env_sh_file.html">cassandra-env.sh</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_topo_file.html">cassandra-topologies.properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_cl_archive_file.html">commitlog-archiving.properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_logback_xml_file.html">logback.xml</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../configuration/cass_jvm_options_file.html">jvm-* files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Operating</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="snitch.html">Snitches</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="topo_changes.html">Topology changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="repair.html">Repair</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="read_repair.html">Read repair</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="hints.html">Hints</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="bloom_filters.html">Bloom filters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="compression.html">Compression</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="cdc.html">Change Data Capture (CDC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="backups.html">Backups</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="bulk_loading.html">Bulk loading</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="metrics.html">Metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="hardware.html">Hardware</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="audit_logging.html">Audit logging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="compaction/index.html">Compaction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../tools/index.html">Tools</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tools/cqlsh.html">cqlsh: the CQL shell</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tools/nodetool/nodetool.html">nodetool</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tools/sstable/index.html">SSTable tools</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../tools/cassandra_stress.html">cassandra-stress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../troubleshooting/index.html">Troubleshooting</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../troubleshooting/finding_nodes.html">Finding misbehaving nodes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../troubleshooting/reading_logs.html">Reading Cassandra logs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../troubleshooting/use_nodetool.html">Using nodetool</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../troubleshooting/use_tools.html">Using external tools to deep-dive</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../development/index.html">Development</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/ide.html">Building and IDE integration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/testing.html">Testing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/patches.html">Contributing code changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/code_style.html">Code style</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/how_to_review.html">Review checklist</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/how_to_commit.html">How to commit</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/documentation.html">Working on documentation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/ci.html">Jenkins CI environment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/dependencies.html">Dependency management</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../development/release_process.html">Release process</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../faq/index.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/index.html">Plug-ins</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cassandra</span>
    <span class="version">3.11</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Cassandra</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../4.0/index.html">4.0-rc.5</a>
        </li>
        <li class="version is-current is-latest">
          <a href="../../index.html">3.11</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>Cassandra</li>
    <li><a href="index.html">Operating</a></li>
    <li><a href="read_repair.html">Read repair</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">3.11</button>
  <div class="version-menu">
    <a class="version" href="../../../4.0/cassandra/operating/read_repair.html">4.0-rc.5</a>
    <a class="version is-current" href="read_repair.html">3.11</a>
  </div>
</div>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/operating/read_repair.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Read repair</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Read Repair is the process of repairing data replicas during a read
request. If all replicas involved in a read request at the given read
consistency level are consistent the data is returned to the client and
no read repair is needed. But if the replicas involved in a read request
at the given consistency level are not consistent a read repair is
performed to make replicas involved in the read request consistent. The
most up-to-date data is returned to the client. The read repair runs in
the foreground and is blocking in that a response is not returned to the
client until the read repair has completed and up-to-date data is
constructed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="expectation-of-monotonic-quorum-reads"><a class="anchor" href="#expectation-of-monotonic-quorum-reads"></a>Expectation of Monotonic Quorum Reads</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra uses a blocking read repair to ensure the expectation of
"monotonic quorum reads" i.e. that in 2 successive quorum reads, it’s
guaranteed the 2nd one won&#8217;t get something older than the 1st one, and
this even if a failed quorum write made a write of the most up to date
value only to a minority of replicas. "Quorum" means majority of nodes
among replicas.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="table-level-configuration-of-monotonic-reads"><a class="anchor" href="#table-level-configuration-of-monotonic-reads"></a>Table level configuration of monotonic reads</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra 4.0 adds support for table level configuration of monotonic
reads
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-14635">CASSANDRA-14635</a>).
The <code>read_repair</code> table option has been added to table schema, with the
options <code>blocking</code> (default), and <code>none</code>.</p>
</div>
<div class="paragraph">
<p>The <code>read_repair</code> option configures the read repair behavior to allow
tuning for various performance and consistency behaviors. Two
consistency properties are affected by read repair behavior.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Monotonic Quorum Reads: Provided by <code>BLOCKING</code>. Monotonic quorum reads
prevents reads from appearing to go back in time in some circumstances.
When monotonic quorum reads are not provided and a write fails to reach
a quorum of replicas, it may be visible in one read, and then disappear
in a subsequent read.</p>
</li>
<li>
<p>Write Atomicity: Provided by <code>NONE</code>. Write atomicity prevents reads
from returning partially applied writes. Cassandra attempts to provide
partition level write atomicity, but since only the data covered by a
<code>SELECT</code> statement is repaired by a read repair, read repair can break
write atomicity when data is read at a more granular level than it is
written. For example read repair can break write atomicity if you write
multiple rows to a clustered partition in a batch, but then select a
single row by specifying the clustering column in a <code>SELECT</code> statement.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The available read repair settings are:</p>
</div>
<div class="sect2">
<h3 id="blocking"><a class="anchor" href="#blocking"></a>Blocking</h3>
<div class="paragraph">
<p>The default setting. When <code>read_repair</code> is set to <code>BLOCKING</code>, and a read
repair is started, the read will block on writes sent to other replicas
until the CL is reached by the writes. Provides monotonic quorum reads,
but not partition level write atomicity.</p>
</div>
</div>
<div class="sect2">
<h3 id="none"><a class="anchor" href="#none"></a>None</h3>
<div class="paragraph">
<p>When <code>read_repair</code> is set to <code>NONE</code>, the coordinator will reconcile any
differences between replicas, but will not attempt to repair them.
Provides partition level write atomicity, but not monotonic quorum
reads.</p>
</div>
<div class="paragraph">
<p>An example of using the <code>NONE</code> setting for the <code>read_repair</code> option is
as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">CREATE TABLE ks.tbl (k INT, c INT, v INT, PRIMARY KEY (k,c)) with read_repair='NONE'");</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="read-repair-example"><a class="anchor" href="#read-repair-example"></a>Read Repair Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To illustrate read repair with an example, consider that a client sends
a read request with read consistency level <code>TWO</code> to a 5-node cluster as
illustrated in Figure 1. Read consistency level determines how many
replica nodes must return a response before the read request is
considered successful.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/Figure_1_read_repair.jpg" alt="image">
</div>
</div>
<div class="paragraph">
<p>Figure 1. Client sends read request to a 5-node Cluster</p>
</div>
<div class="paragraph">
<p>Three nodes host replicas for the requested data as illustrated in
Figure 2. With a read consistency level of <code>TWO</code> two replica nodes must
return a response for the read request to be considered successful. If
the node the client sends request to hosts a replica of the data
requested only one other replica node needs to be sent a read request
to. But if the receiving node does not host a replica for the requested
data the node becomes a coordinator node and forwards the read request
to a node that hosts a replica. A direct read request is forwarded to
the fastest node (as determined by dynamic snitch) as shown in Figure 2.
A direct read request is a full read and returns the requested data.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/Figure_2_read_repair.jpg" alt="image">
</div>
</div>
<div class="paragraph">
<p>Figure 2. Direct Read Request sent to Fastest Replica Node</p>
</div>
<div class="paragraph">
<p>Next, the coordinator node sends the requisite number of additional
requests to satisfy the consistency level, which is <code>TWO</code>. The
coordinator node needs to send one more read request for a total of two.
All read requests additional to the first direct read request are digest
read requests. A digest read request is not a full read and only returns
the hash value of the data. Only a hash value is returned to reduce the
network data traffic. In the example being discussed the coordinator
node sends one digest read request to a node hosting a replica as
illustrated in Figure 3.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/Figure_3_read_repair.jpg" alt="image">
</div>
</div>
<div class="paragraph">
<p>Figure 3. Coordinator Sends a Digest Read Request</p>
</div>
<div class="paragraph">
<p>The coordinator node has received a full copy of data from one node and
a hash value for the data from another node. To compare the data
returned a hash value is calculated for the full copy of data. The two
hash values are compared. If the hash values are the same no read repair
is needed and the full copy of requested data is returned to the client.
The coordinator node only performed a total of two replica read request
because the read consistency level is <code>TWO</code> in the example. If the
consistency level were higher such as <code>THREE</code>, three replica nodes would
need to respond to a read request and only if all digest or hash values
were to match with the hash value of the full copy of data would the
read request be considered successful and the data returned to the
client.</p>
</div>
<div class="paragraph">
<p>But, if the hash value/s from the digest read request/s are not the same
as the hash value of the data from the full read request of the first
replica node it implies that an inconsistency in the replicas exists. To
fix the inconsistency a read repair is performed.</p>
</div>
<div class="paragraph">
<p>For example, consider that that digest request returns a hash value that
is not the same as the hash value of the data from the direct full read
request. We would need to make the replicas consistent for which the
coordinator node sends a direct (full) read request to the replica node
that it sent a digest read request to earlier as illustrated in Figure
4.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/Figure_4_read_repair.jpg" alt="image">
</div>
</div>
<div class="paragraph">
<p>Figure 4. Coordinator sends Direct Read Request to Replica Node it had
sent Digest Read Request to</p>
</div>
<div class="paragraph">
<p>After receiving the data from the second replica node the coordinator
has data from two of the replica nodes. It only needs two replicas as
the read consistency level is <code>TWO</code> in the example. Data from the two
replicas is compared and based on the timestamps the most recent replica
is selected. Data may need to be merged to construct an up-to-date copy
of data if one replica has data for only some of the columns. In the
example, if the data from the first direct read request is found to be
outdated and the data from the second full read request to be the latest
read, repair needs to be performed on Replica 2. If a new up-to-date
data is constructed by merging the two replicas a read repair would be
needed on both the replicas involved. For example, a read repair is
performed on Replica 2 as illustrated in Figure 5.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/Figure_5_read_repair.jpg" alt="image">
</div>
</div>
<div class="paragraph">
<p>Figure 5. Coordinator performs Read Repair</p>
</div>
<div class="paragraph">
<p>The most up-to-date data is returned to the client as illustrated in
Figure 6. From the three replicas Replica 1 is not even read and thus
not repaired. Replica 2 is repaired. Replica 3 is the most up-to-date
and returned to client.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/Figure_6_read_repair.jpg" alt="image">
</div>
</div>
<div class="paragraph">
<p>Figure 6. Most up-to-date Data returned to Client</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="read-consistency-level-and-read-repair"><a class="anchor" href="#read-consistency-level-and-read-repair"></a>Read Consistency Level and Read Repair</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The read consistency is most significant in determining if a read repair
needs to be performed. As discussed in Table 1 a read repair is not
needed for all of the consistency levels.</p>
</div>
<div class="paragraph">
<p>Table 1. Read Repair based on Read Consistency Level</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 93%;">
<colgroup>
<col style="width: 35%;">
<col style="width: 65%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Read Consistency Level</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read repair is not performed as the data from the first direct
read request satisfies the consistency level ONE. No digest read
requests are involved for finding mismatches in data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">TWO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read repair is performed if inconsistencies in data are found as
determined by the direct and digest read requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">THREE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read repair is performed if inconsistencies in data are found as
determined by the direct and digest read requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOCAL_ONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read repair is not performed as the data from the direct
read request from the closest replica satisfies the consistency level
LOCAL_ONE.No digest read requests are involved for finding mismatches in
data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">LOCAL_QUORUM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read repair is performed if inconsistencies in data are
found as determined by the direct and digest read requests.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">QUORUM</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read repair is performed if inconsistencies in data are found
as determined by the direct and digest read requests.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If read repair is performed it is made only on the replicas that are not
up-to-date and that are involved in the read request. The number of
replicas involved in a read request would be based on the read
consistency level; in the example it is two.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="improved-read-repair-blocking-behavior-in-cassandra-4-0"><a class="anchor" href="#improved-read-repair-blocking-behavior-in-cassandra-4-0"></a>Improved Read Repair Blocking Behavior in Cassandra 4.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra 4.0 makes two improvements to read repair blocking behavior
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-10726">CASSANDRA-10726</a>).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Speculative Retry of Full Data Read Requests. Cassandra 4.0 makes use
of speculative retry in sending read requests (full, not digest) to
replicas if a full data response is not received, whether in the initial
full read request or a full data read request during read repair. With
speculative retry if it looks like a response may not be received from
the initial set of replicas Cassandra sent messages to, to satisfy the
consistency level, it speculatively sends additional read request to
un-contacted replica/s. Cassandra 4.0 will also speculatively send a
repair mutation to a minority of nodes not involved in the read repair
data read / write cycle with the combined contents of all
un-acknowledged mutations if it looks like one may not respond.
Cassandra accepts acks from them in lieu of acks from the initial
mutations sent out, so long as it receives the same number of acks as
repair mutations transmitted.</p>
</li>
<li>
<p>Only blocks on Full Data Responses to satisfy the Consistency Level.
Cassandra 4.0 only blocks for what is needed for resolving the digest
mismatch and wait for enough full data responses to meet the consistency
level, no matter whether it’s speculative retry or read repair chance.
As an example, if it looks like Cassandra might not receive full data
requests from everyone in time, it sends additional requests to
additional replicas not contacted in the initial full data read. If the
collection of nodes that end up responding in time end up agreeing on
the data, the response from the disagreeing replica that started the
read repair is not considered, and won&#8217;t be included in the response to
the client, preserving the expectation of monotonic quorum reads.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="diagnostic-events-for-read-repairs"><a class="anchor" href="#diagnostic-events-for-read-repairs"></a>Diagnostic Events for Read Repairs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cassandra 4.0 adds diagnostic events for read repair
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-14668">CASSANDRA-14668</a>)
that can be used for exposing information such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Contacted endpoints</p>
</li>
<li>
<p>Digest responses by endpoint</p>
</li>
<li>
<p>Affected partition keys</p>
</li>
<li>
<p>Speculated reads / writes</p>
</li>
<li>
<p>Update oversized</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="background-read-repair"><a class="anchor" href="#background-read-repair"></a>Background Read Repair</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Background read repair, which was configured using <code>read_repair_chance</code>
and <code>dclocal_read_repair_chance</code> settings in <code>cassandra.yaml</code> is removed
Cassandra 4.0
(<a href="https://issues.apache.org/jira/browse/CASSANDRA-13910">CASSANDRA-13910</a>).</p>
</div>
<div class="paragraph">
<p>Read repair is not an alternative for other kind of repairs such as full
repairs or replacing a node that keeps failing. The data returned even
after a read repair has been performed may not be the most up-to-date
data if consistency level is other than one requiring response from all
replicas.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p> © 2020 <a href="https://apache.org">The Apache Software Foundation.</a> Apache, the Apache feather logo, and Apache Cassandra are trademarks of The Apache Software Foundation.
   <a href="https://twitter.com/cassandra"
           class="twitter-follow-button"
           data-show-count="false" data-size="large">Follow @cassandra</a>
           <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <a href="https://twitter.com/intent/tweet?button_hashtag=cassandra"
           class="twitter-hashtag-button"
           data-size="large"
           data-related="ApacheCassandra">Tweet #cassandra</a>
  <a class="subscribe-rss" href="/feed.xml" title="Subscribe to Blog via RSS"><img src="../../../../_/img/Feed-icon.svg"></a>
  </p>
</footer>
<script>
  window.antora = window.antora || {}
  window.antora.basePath = '../../../..'
  window.antora.pagePath = '/Cassandra/3.11/cassandra/operating/read_repair.html'
</script>
<script src="../../../../_/js/site.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/vendor/search.js"></script>
<script async src="../../../../_/../search-index.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<!-- Javascript. Placed here so pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/underscore-min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  </body>
</html>
