<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Compaction :: Apache Cassandra Documentation</title>
    <link rel="canonical" href="file:///Users/lorina.poland/docs-site/build/site/Cassandra/4.0/Cassandra/3.11/cassandra/operating/compaction/index.html">
    <meta name="generator" content="Antora 2.3.1">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
<link rel="stylesheet" href="../../../../../_/css/search.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="file:///Users/lorina.poland/docs-site/build/site/Cassandra/4.0">&nbsp;&nbsp;&nbsp;<img src="../../../../../_/img/cassandra_logo.png"></a>
        <div class="navbar-item">
          <input id="search-input" type="text" placeholder="Search docs">
        </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://cassandra.apache.org">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/download/">Download</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/3.11.6/apache-cassandra-3.11.6-bin.tar.gz">Latest</a>
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/3.11.6/apache-cassandra-3.11.6-bin.tar.gz">3.x</a>
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/3.0.20/apache-cassandra-3.0.20-bin.tar.gz">3.0</a>
            <a class="navbar-item" href="https://www.apache.org/dyn/closer.lua/cassandra/2.1.21/apache-cassandra-2.1.21-bin.tar.gz">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/doc/">Documentation</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://cassandra.apache.org/doc/">Latest</a>
            <a class="navbar-item" href="">3.x</a>
            <a class="navbar-item" href="https://cassandra.apache.org/doc/old/CQL-3.0.html">3.0</a>
            <a class="navbar-item" href="https://cassandra.apache.org/doc/old/CQL-2.1.html">2.1</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/community/">Community</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://lists.apache.org/list.html?dev@cassandra.apache.org">Developer Mailing List</a>
            <a class="navbar-item" href="https://lists.apache.org/list.html?user@cassandra.apache.org">User Mailing List</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="https://cassandra.apache.org/blog/">Blog</a>
	</div>
          </span>
        </div>
      </div>
    </div>
  </nav>
  <nav class="navbar2">
    <div class="navbar2-brand">
      <a class="navbar2-item href="https://asf.org"><img src="../../../../../_/img/asf_feather.png" height="70%">&nbsp;&nbsp;&nbsp;Apache Software Foundation / Apache Cassandra</a>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="Cassandra" data-version="3.11">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../index.html">Cassandra</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../index.html">Main</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../glossary.html">Glossary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../bugs.html">How to report bugs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../contactus.html">Contact us</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Cassandra</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../getting_started/index.html">Getting Started</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../getting_started/installing.html">Installing Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../getting_started/configuring.html">Configuring Cassandra</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../getting_started/querying.html">Inserting and querying</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../getting_started/drivers.html">Client drivers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../getting_started/production.html">Production recommendations</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../new/index.html">What&#8217;s new</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/java11.html">Support for Java 11</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/virtualtables.html">Virtual tables</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/auditlogging.html">Audit logging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/fqllogging.html">Full query logging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/messaging.html">Improved internode Messaging</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/streaming.html">Improved streaming</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../new/transientreplication.html">Transient replication</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../architecture/index.html">Architecture</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../architecture/overview.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../architecture/dynamo.html">Dynamo</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../architecture/storage_engine.html">Storage engine</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../architecture/guarantees.html">Guarantees</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../data_modeling/index.html">Data modeling</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/intro.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_conceptual.html">Conceptual data modeling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_rdbms.html">RDBMS design</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_queries.html">Defining application queries</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_logical.html">Logical data modeling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_physical.html">Physical data modeling</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_refining.html">Evaluating and refining data models</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_schema.html">Defining database schema</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../data_modeling/data_modeling_tools.html">Cassandra data modeling tools</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#cql/index.adoc{">CQL</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/definitions.html">Definitions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/types.html">Data types</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/ddl.html">DDL</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/dml.html">DML</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/indexes.html">Secondary indexes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/mvs.html">Materialized views</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/functions.html">Functions</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/operators.html">Operators</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/json.html">JSON</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/triggers.html">Triggers</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/appendices.html">Appendices</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../cql/changes.html">Changes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../configuration/index.html">Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_yaml_file.html">cassandra.yaml</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_rackdc_file.html">cassandra-rackdc.properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_env_sh_file.html">cassandra-env.sh</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_topo_file.html">cassandra-topologies.properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_cl_archive_file.html">commitlog-archiving.properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_logback_xml_file.html">logback.xml</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../configuration/cass_jvm_options_file.html">jvm-* files</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../index.html">Operating</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../snitch.html">Snitches</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../topo_changes.html">Topology changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../repair.html">Repair</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../read_repair.html">Read repair</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../hints.html">Hints</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../bloom_filters.html">Bloom filters</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../compression.html">Compression</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../cdc.html">Change Data Capture (CDC)</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../backups.html">Backups</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../bulk_loading.html">Bulk loading</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../metrics.html">Metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../security.html">Security</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../hardware.html">Hardware</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../audit_logging.html">Audit logging</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="index.html">Compaction</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../tools/index.html">Tools</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tools/cqlsh.html">cqlsh: the CQL shell</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tools/nodetool/nodetool.html">nodetool</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tools/sstable/index.html">SSTable tools</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../tools/cassandra_stress.html">cassandra-stress</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../troubleshooting/index.html">Troubleshooting</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../troubleshooting/finding_nodes.html">Finding misbehaving nodes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../troubleshooting/reading_logs.html">Reading Cassandra logs</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../troubleshooting/use_nodetool.html">Using nodetool</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../troubleshooting/use_tools.html">Using external tools to deep-dive</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../development/index.html">Development</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/gettingstarted.html">Getting started</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/ide.html">Building and IDE integration</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/testing.html">Testing</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/patches.html">Contributing code changes</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/code_style.html">Code style</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/how_to_review.html">Review checklist</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/how_to_commit.html">How to commit</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/documentation.html">Working on documentation</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/ci.html">Jenkins CI environment</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/dependencies.html">Dependency management</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../development/release_process.html">Release process</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../faq/index.html">FAQ</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../plugins/index.html">Plug-ins</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Cassandra</span>
    <span class="version">3.11</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Cassandra</span>
      <ul class="versions">
        <li class="version">
          <a href="../../../../4.0/index.html">4.0-rc.5</a>
        </li>
        <li class="version is-current is-latest">
          <a href="../../../index.html">3.11</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li>Cassandra</li>
    <li><a href="../index.html">Operating</a></li>
    <li><a href="index.html">Compaction</a></li>
  </ul>
</nav>
<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">3.11</button>
  <div class="version-menu">
    <a class="version" href="../../../../4.0/cassandra/operating/compaction/index.html">4.0-rc.5</a>
    <a class="version is-current" href="index.html">3.11</a>
  </div>
</div>
  <div class="edit-this-page"><a href="file:///Users/lorina.poland/CLONES/cassandra-examples/rst-to-asciidoc-tests/ASCIIDOC/modules/cassandra/pages/operating/compaction/index.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<article class="doc">
<h1 class="page">Compaction</h1>
<div class="sect1">
<h2 id="strategies"><a class="anchor" href="#strategies"></a>Strategies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Picking the right compaction strategy for your workload will ensure the
best performance for both querying and for compaction itself.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Size Tiered Compaction Strategy &lt;stcs&gt;</code></dt>
<dd>
<p>The default compaction strategy. Useful as a fallback when other
strategies don&#8217;t fit the workload. Most useful for non pure time
series workloads with spinning disks, or when the I/O from <code>LCS &lt;lcs&gt;</code>
is too high.</p>
</dd>
<dt class="hdlist1"><code>Leveled Compaction Strategy &lt;lcs&gt;</code></dt>
<dd>
<p>Leveled Compaction Strategy (LCS) is optimized for read heavy
workloads, or workloads with lots of updates and deletes. It is not a
good choice for immutable time series data.</p>
</dd>
<dt class="hdlist1"><code>Time Window Compaction Strategy &lt;twcs&gt;</code></dt>
<dd>
<p>Time Window Compaction Strategy is designed for TTL&#8217;ed, mostly
immutable time series data.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="types-of-compaction"><a class="anchor" href="#types-of-compaction"></a>Types of compaction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The concept of compaction is used for different kinds of operations in
Cassandra, the common thing about these operations is that it takes one
or more sstables and output new sstables. The types of compactions are;</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Minor compaction</dt>
<dd>
<p>triggered automatically in Cassandra.</p>
</dd>
<dt class="hdlist1">Major compaction</dt>
<dd>
<p>a user executes a compaction over all sstables on the node.</p>
</dd>
<dt class="hdlist1">User defined compaction</dt>
<dd>
<p>a user triggers a compaction on a given set of sstables.</p>
</dd>
<dt class="hdlist1">Scrub</dt>
<dd>
<p>try to fix any broken sstables. This can actually remove valid data if
that data is corrupted, if that happens you will need to run a full
repair on the node.</p>
</dd>
<dt class="hdlist1">Upgradesstables</dt>
<dd>
<p>upgrade sstables to the latest version. Run this after upgrading to a
new major version.</p>
</dd>
<dt class="hdlist1">Cleanup</dt>
<dd>
<p>remove any ranges this node does not own anymore, typically triggered
on neighbouring nodes after a node has been bootstrapped since that
node will take ownership of some ranges from those nodes.</p>
</dd>
<dt class="hdlist1">Secondary index rebuild</dt>
<dd>
<p>rebuild the secondary indexes on the node.</p>
</dd>
<dt class="hdlist1">Anticompaction</dt>
<dd>
<p>after repair the ranges that were actually repaired are split out of
the sstables that existed when repair started.</p>
</dd>
<dt class="hdlist1">Sub range compaction</dt>
<dd>
<p>It is possible to only compact a given sub range - this could be
useful if you know a token that has been misbehaving - either
gathering many updates or many deletes.
(<code>nodetool compact -st x -et y</code>) will pick all sstables containing the
range between x and y and issue a compaction for those sstables. For
STCS this will most likely include all sstables but with LCS it can
issue the compaction for a subset of the sstables. With LCS the
resulting sstable will end up in L0.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="when-is-a-minor-compaction-triggered"><a class="anchor" href="#when-is-a-minor-compaction-triggered"></a>When is a minor compaction triggered?</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>When an sstable is added to the node through flushing/streaming etc. #
When autocompaction is enabled after being disabled
(<code>nodetool enableautocompaction</code>) # When compaction adds new sstables. #
A check for new minor compactions every 5 minutes.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="merging-sstables"><a class="anchor" href="#merging-sstables"></a>Merging sstables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Compaction is about merging sstables, since partitions in sstables are
sorted based on the hash of the partition key it is possible to
efficiently merge separate sstables. Content of each partition is also
sorted so each partition can be merged efficiently.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tombstones-and-garbage-collection-gc-grace"><a class="anchor" href="#tombstones-and-garbage-collection-gc-grace"></a>Tombstones and Garbage Collection (GC) Grace</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="why-tombstones"><a class="anchor" href="#why-tombstones"></a>Why Tombstones</h3>
<div class="paragraph">
<p>When a delete request is received by Cassandra it does not actually
remove the data from the underlying store. Instead it writes a special
piece of data known as a tombstone. The Tombstone represents the delete
and causes all values which occurred before the tombstone to not appear
in queries to the database. This approach is used instead of removing
values because of the distributed nature of Cassandra.</p>
</div>
</div>
<div class="sect2">
<h3 id="deletes-without-tombstones"><a class="anchor" href="#deletes-without-tombstones"></a>Deletes without tombstones</h3>
<div class="paragraph">
<p>Imagine a three node cluster which has the value [A] replicated to every
node.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">[A], [A], [A]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If one of the nodes fails and and our delete operation only removes
existing values we can end up with a cluster that looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">[], [], [A]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a repair operation would replace the value of [A] back onto the two
nodes which are missing the value.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">[A], [A], [A]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This would cause our data to be resurrected even though it had been
deleted.</p>
</div>
</div>
<div class="sect2">
<h3 id="deletes-with-tombstones"><a class="anchor" href="#deletes-with-tombstones"></a>Deletes with Tombstones</h3>
<div class="paragraph">
<p>Starting again with a three node cluster which has the value [A]
replicated to every node.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">[A], [A], [A]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If instead of removing data we add a tombstone record, our single node
failure situation will look like this.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">[A, Tombstone[A]], [A, Tombstone[A]], [A]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we issue a repair the Tombstone will be copied to the replica,
rather than the deleted data being resurrected.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">[A, Tombstone[A]], [A, Tombstone[A]], [A, Tombstone[A]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our repair operation will correctly put the state of the system to what
we expect with the record [A] marked as deleted on all nodes. This does
mean we will end up accruing Tombstones which will permanently
accumulate disk space. To avoid keeping tombstones forever we have a
parameter known as <code>gc_grace_seconds</code> for every table in Cassandra.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-gc_grace_seconds-parameter-and-tombstone-removal"><a class="anchor" href="#the-gc_grace_seconds-parameter-and-tombstone-removal"></a>The gc_grace_seconds parameter and Tombstone Removal</h3>
<div class="paragraph">
<p>The table level <code>gc_grace_seconds</code> parameter controls how long Cassandra
will retain tombstones through compaction events before finally removing
them. This duration should directly reflect the amount of time a user
expects to allow before recovering a failed node. After
<code>gc_grace_seconds</code> has expired the tombstone may be removed (meaning
there will no longer be any record that a certain piece of data was
deleted), but as a tombstone can live in one sstable and the data it
covers in another, a compaction must also include both sstable for a
tombstone to be removed. More precisely, to be able to drop an actual
tombstone the following needs to be true;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The tombstone must be older than <code>gc_grace_seconds</code></p>
</li>
<li>
<p>If partition X contains the tombstone, the sstable containing the
partition plus all sstables containing data older than the tombstone
containing X must be included in the same compaction. We don&#8217;t need to
care if the partition is in an sstable if we can guarantee that all data
in that sstable is newer than the tombstone. If the tombstone is older
than the data it cannot shadow that data.</p>
</li>
<li>
<p>If the option <code>only_purge_repaired_tombstones</code> is enabled, tombstones
are only removed if the data has also been repaired.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If a node remains down or disconnected for longer than
<code>gc_grace_seconds</code> it&#8217;s deleted data will be repaired back to the other
nodes and re-appear in the cluster. This is basically the same as in the
"Deletes without Tombstones" section. Note that tombstones will not be
removed until a compaction event even if <code>gc_grace_seconds</code> has elapsed.</p>
</div>
<div class="paragraph">
<p>The default value for <code>gc_grace_seconds</code> is 864000 which is equivalent
to 10 days. This can be set when creating or altering a table using
<code>WITH gc_grace_seconds</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ttl"><a class="anchor" href="#ttl"></a>TTL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Data in Cassandra can have an additional property called time to live -
this is used to automatically drop data that has expired once the time
is reached. Once the TTL has expired the data is converted to a
tombstone which stays around for at least <code>gc_grace_seconds</code>. Note that
if you mix data with TTL and data without TTL (or just different length
of the TTL) Cassandra will have a hard time dropping the tombstones
created since the partition might span many sstables and not all are
compacted at once.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="fully-expired-sstables"><a class="anchor" href="#fully-expired-sstables"></a>Fully expired sstables</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If an sstable contains only tombstones and it is guaranteed that that
sstable is not shadowing data in any other sstable compaction can drop
that sstable. If you see sstables with only tombstones (note that TTL:ed
data is considered tombstones once the time to live has expired) but it
is not being dropped by compaction, it is likely that other sstables
contain older data. There is a tool called <code>sstableexpiredblockers</code> that
will list which sstables are droppable and which are blocking them from
being dropped. This is especially useful for time series compaction with
<code>TimeWindowCompactionStrategy</code> (and the deprecated
<code>DateTieredCompactionStrategy</code>). With <code>TimeWindowCompactionStrategy</code> it
is possible to remove the guarantee (not check for shadowing data) by
enabling <code>unsafe_aggressive_sstable_expiration</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="repairedunrepaired-data"><a class="anchor" href="#repairedunrepaired-data"></a>Repaired/unrepaired data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With incremental repairs Cassandra must keep track of what data is
repaired and what data is unrepaired. With anticompaction repaired data
is split out into repaired and unrepaired sstables. To avoid mixing up
the data again separate compaction strategy instances are run on the two
sets of data, each instance only knowing about either the repaired or
the unrepaired sstables. This means that if you only run incremental
repair once and then never again, you might have very old data in the
repaired sstables that block compaction from dropping tombstones in the
unrepaired (probably newer) sstables.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="data-directories"><a class="anchor" href="#data-directories"></a>Data directories</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since tombstones and data can live in different sstables it is important
to realize that losing an sstable might lead to data becoming live again
- the most common way of losing sstables is to have a hard drive break
down. To avoid making data live tombstones and actual data are always in
the same data directory. This way, if a disk is lost, all versions of a
partition are lost and no data can get undeleted. To achieve this a
compaction strategy instance per data directory is run in addition to
the compaction strategy instances containing repaired/unrepaired data,
this means that if you have 4 data directories there will be 8
compaction strategy instances running. This has a few more benefits than
just avoiding data getting undeleted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is possible to run more compactions in parallel - leveled
compaction will have several totally separate levelings and each one can
run compactions independently from the others.</p>
</li>
<li>
<p>Users can backup and restore a single data directory.</p>
</li>
<li>
<p>Note though that currently all data directories are considered equal,
so if you have a tiny disk and a big disk backing two data directories,
the big one will be limited the by the small one. One work around to
this is to create more data directories backed by the big disk.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="single-sstable-tombstone-compaction"><a class="anchor" href="#single-sstable-tombstone-compaction"></a>Single sstable tombstone compaction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When an sstable is written a histogram with the tombstone expiry times
is created and this is used to try to find sstables with very many
tombstones and run single sstable compaction on that sstable in hope of
being able to drop tombstones in that sstable. Before starting this it
is also checked how likely it is that any tombstones will actually will
be able to be dropped how much this sstable overlaps with other
sstables. To avoid most of these checks the compaction option
<code>unchecked_tombstone_compaction</code> can be enabled.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compaction-options"><a class="anchor" href="#compaction-options"></a>Common options</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is a number of common options for all the compaction strategies;</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>enabled</code> (default: true)</dt>
<dd>
<p>Whether minor compactions should run. Note that you can have
'enabled': true as a compaction option and then do 'nodetool
enableautocompaction' to start running compactions.</p>
</dd>
<dt class="hdlist1"><code>tombstone_threshold</code> (default: 0.2)</dt>
<dd>
<p>How much of the sstable should be tombstones for us to consider doing
a single sstable compaction of that sstable.</p>
</dd>
<dt class="hdlist1"><code>tombstone_compaction_interval</code> (default: 86400s (1 day))</dt>
<dd>
<p>Since it might not be possible to drop any tombstones when doing a
single sstable compaction we need to make sure that one sstable is not
constantly getting recompacted - this option states how often we
should try for a given sstable.</p>
</dd>
<dt class="hdlist1"><code>log_all</code> (default: false)</dt>
<dd>
<p>New detailed compaction logging, see
<code>below &lt;detailed-compaction-logging&gt;</code>.</p>
</dd>
<dt class="hdlist1"><code>unchecked_tombstone_compaction</code> (default: false)</dt>
<dd>
<p>The single sstable compaction has quite strict checks for whether it
should be started, this option disables those checks and for some
usecases this might be needed. Note that this does not change anything
for the actual compaction, tombstones are only dropped if it is safe
to do so - it might just rewrite an sstable without being able to drop
any tombstones.</p>
</dd>
<dt class="hdlist1"><code>only_purge_repaired_tombstone</code> (default: false)</dt>
<dd>
<p>Option to enable the extra safety of making sure that tombstones are
only dropped if the data has been repaired.</p>
</dd>
<dt class="hdlist1"><code>min_threshold</code> (default: 4)</dt>
<dd>
<p>Lower limit of number of sstables before a compaction is triggered.
Not used for <code>LeveledCompactionStrategy</code>.</p>
</dd>
<dt class="hdlist1"><code>max_threshold</code> (default: 32)</dt>
<dd>
<p>Upper limit of number of sstables before a compaction is triggered.
Not used for <code>LeveledCompactionStrategy</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Further, see the section on each strategy for specific additional
options.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compaction-nodetool-commands"><a class="anchor" href="#compaction-nodetool-commands"></a>Compaction nodetool commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>nodetool &lt;nodetool&gt;</code> utility provides a number of commands related
to compaction:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>enableautocompaction</code></dt>
<dd>
<p>Enable compaction.</p>
</dd>
<dt class="hdlist1"><code>disableautocompaction</code></dt>
<dd>
<p>Disable compaction.</p>
</dd>
<dt class="hdlist1"><code>setcompactionthroughput</code></dt>
<dd>
<p>How fast compaction should run at most - defaults to 16MB/s, but note
that it is likely not possible to reach this throughput.</p>
</dd>
<dt class="hdlist1"><code>compactionstats</code></dt>
<dd>
<p>Statistics about current and pending compactions.</p>
</dd>
<dt class="hdlist1"><code>compactionhistory</code></dt>
<dd>
<p>List details about the last compactions.</p>
</dd>
<dt class="hdlist1"><code>setcompactionthreshold</code></dt>
<dd>
<p>Set the min/max sstable count for when to trigger compaction, defaults
to 4/32.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="switching-the-compaction-strategy-and-options-using-jmx"><a class="anchor" href="#switching-the-compaction-strategy-and-options-using-jmx"></a>Switching the compaction strategy and options using JMX</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to switch compaction strategies and its options on just a
single node using JMX, this is a great way to experiment with settings
without affecting the whole cluster. The mbean is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">org.apache.cassandra.db:type=ColumnFamilies,keyspace=&lt;keyspace_name&gt;,columnfamily=&lt;table_name&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the attribute to change is <code>CompactionParameters</code> or
<code>CompactionParametersJson</code> if you use jconsole or jmc. The syntax for
the json version is the same as you would use in an
<code>ALTER TABLE &lt;alter-table-statement&gt;</code> statement -for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs" data-lang="none">{ 'class': 'LeveledCompactionStrategy', 'sstable_size_in_mb': 123, 'fanout_size': 10}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The setting is kept until someone executes an
<code>ALTER TABLE &lt;alter-table-statement&gt;</code> that touches the compaction
settings or restarts the node.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="detailed-compaction-logging"><a class="anchor" href="#detailed-compaction-logging"></a>More detailed compaction logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Enable with the compaction option <code>log_all</code> and a more detailed
compaction log file will be produced in your log directory.</p>
</div>
</div>
</div>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <p> © 2020 <a href="https://apache.org">The Apache Software Foundation.</a> Apache, the Apache feather logo, and Apache Cassandra are trademarks of The Apache Software Foundation.
   <a href="https://twitter.com/cassandra"
           class="twitter-follow-button"
           data-show-count="false" data-size="large">Follow @cassandra</a>
           <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <a href="https://twitter.com/intent/tweet?button_hashtag=cassandra"
           class="twitter-hashtag-button"
           data-size="large"
           data-related="ApacheCassandra">Tweet #cassandra</a>
  <a class="subscribe-rss" href="/feed.xml" title="Subscribe to Blog via RSS"><img src="../../../../../_/img/Feed-icon.svg"></a>
  </p>
</footer>
<script>
  window.antora = window.antora || {}
  window.antora.basePath = '../../../../..'
  window.antora.pagePath = '/Cassandra/3.11/cassandra/operating/compaction/index.html'
</script>
<script src="../../../../../_/js/site.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/vendor/search.js"></script>
<script async src="../../../../../_/../search-index.js"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<!-- Javascript. Placed here so pages load faster -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="js/underscore-min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  </body>
</html>
